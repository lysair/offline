-- SPDX-License-Identifier: GPL-3.0-or-later

local desc = [[
  # 太虚幻魇模式（线下版）简介

  ---

  本模式是线下发行的**官方正版模式**，货号S0197，产品名《三国杀：国际服-太虚幻魇》。
  
  **与国际服线上规则不完全相同！**

  ---

  ## 背景故事

  中平元年，葛玄辞别恩师左慈，负剑下山。行至崆峒绝壁，忽见云海翻涌，天光骤裂，竟被卷入太虚幻境。此地光阴错乱，因果交织，葛玄方知自己踏入了一条可改天命的时空长河……

  玩家扮演葛玄，特定时间节点在幻境里发生变化，玩家的冒险其实是修正节点，如果失败幻境会波及观实世界。

  ---

  ## 玩法综述

  《三国杀：国际服-太虚幻魇》是以三国杀玩法为主体、以关卡推进为形式，进行的不对称阵营对抗类游戏。

  在一场游戏之前，玩家需按照说明书了解游戏目标，进行游戏设置。当结束所有关卡后，凡人玩家取得胜利；当关卡未结束时，凡人玩家失去了所有的游戏机会（后面会有具体描述），则幻魇阵营获胜。

  ---

  ## 游戏目标

  凡人：通过击杀所有幻魇解救武将化为力量（即抽取武将牌并获得其中一个技能），在保证命数消耗至0之前完成所有的关卡，从而击碎太虚幻境，即为获得游戏胜利。

  幻魇：作为地狱的恶鬼，在每一关中依照规则选择专属的幻魇武将阻止凡人离开太虚幻境，在每一关中竭尽全力击杀凡人，将凡人的命数消耗殆尽，获得游戏胜利。

  ---

  ## 游戏规则

  ①凡人初始有10点命数。游戏开始时，凡人随机从武将牌堆中抽取三张并获得两个技能（每关至多携带4个技能）。

  ②幻魇每关开始时依照关卡说明提供的座次和武将牌进行布局。
  
  ③所有玩家初始手牌均为4张，凡人初始体力和体力上限为4，幻魇体力和体力上限以武将牌为准。
  
  ④凡人在一关结束后，获得1点命数，抽取一张武将牌并获得其中一个技能。

  ⑤凡人玩家在单局游戏阵亡后，可以立刻消耗1点命数复活。

  ★为便于线上轻松游戏，新月杀进行了以下改动：

  游戏开始前，凡人玩家可以自由选定开始的剧本，不必须从第一关开始。若直接选择靠后的关卡，初始选择技能给予一定的加成。

  房间人数为3~5人，若人数不满足剧本关卡的固定配置，则随机增删对应的关卡角色。

  由于难度较高，建议开启自选武将，游戏开始前事先商量允许选择的范围和要游玩的剧本。
  
  ---

  ## 关卡

  **第一关：黄天之怒**

  太虚幻境的真传之秘诱惑了张角，寄予了黄巾三兄弟更高的法力，但也让他们变得更为自傲和狂暴。比起现实世界中快速被镇压，仅作为乱世开始的黄巾之乱，这一次的风波显然更为恐怖。
  
  1号位凡人  2号位魇张宝  3号位魇张角  4号位魇张梁

  **第二关：何进诛宦**

  大将军何进准备诛宦，但停滞不前反为宦官所害。袁绍曹操带人前往北宫打算为何进报仇，却发现宦官已经先行逃窜，原来大将军没有死，或者说是死而复生了……

  1号位凡人  2号位魇张让  3号位魇何进  4号位魇袁绍

  **第三关：董卓乱京**

  董卓进京之后残暴不仁，屠戮百姓，辱污皇权。曹操借王允之刀刺杀董卓失败，仓皇逃窜出关，他给踌躇不前的关外诸侯带来一个恐怖的消息：董卓变得如此残暴，是有原因的……

  （玩家未使用过复活） 1号位凡人  2号位魇李傕  3号位魇樊稠  4号位魇郭汜  5号位魇张济

  （玩家已使用过复活） 1号位凡人  2号位魇高顺  3号位魇吕布  4号位魇李儒  5号位魇董卓

  **第四关：仲帝野望**

  得到了玉玺以后的袁术自号仲家帝，在淮南建立了恐怖的帝国，民不聊生。曹操、刘备，甚至是原先在袁术手下的孙策都决定去讨伐这个伪帝。可是踏入仲家国境的一刻，他们发现事情比想象中要棘手很多。

  1号位凡人  2号位魇纪灵  3号位骸骨龙  4号位魇乐就  5号位魇袁术

  **第五关：鬼神之怒**

  袁术的邪灵帝国覆灭前，曾打算和这个天下最强的战神吕布结盟，他派出的使者中就有仓皇逃窜去的■■■，将真传之秘带给了吕布。吕布原先依仗自己的武力对此不屑一顾，但这次强敌环同的他不得不需要更强的勇力。下邳落日战，在此开场……

  1号位凡人  2号位魇高顺/魇神吕布  3号位魇神吕布/魇貂蝉  4号位魇星张辽  5号位魇陈宫
  
  **第六关：白马之锋**

  白马义从——汉末最强大的骑兵，他们的拥有者公孙瓒讨灭了爱民如子的刘虞。究竟是因为野心，还是又一个真传之秘的牺牲品呢？本就要荡平中原北陆的袁绍并没有多想，直面过太多怪事的他，已经做好了正面交锋的准备……

  1号位凡人  2号位魇麴义  3号位魇公孙瓒  4号位魇SP赵云

  **第七关：霸王征程**

  孙策得到了自己父亲留下的原班人马的支持，又结识了文武双全的好友周瑜，凭借他们的支持，孙氏席卷江东。可是突然出现的太平于吉，让这位小霸王突然陨落。正当各方诸候的智囊在揣度之后的天下会有何变化之时，有消息传来，说孙策死而复生，还带来了真正的“霸王项羽”。

  1号位凡人  2号位魇小乔/魇太史慈  3号位魇周瑜/魇孙策  4号位无/魇大乔
  
  **第八关：官渡之战**

  在易京击败了公孙瓒以后，袁绍自然是得到了真传之秘。对于他来说，四世三公的名望和强大的势力已经是问鼎天下足够的资本了，本不需要借助外力就可以征服这一切。但是，年龄的增长，内部智囊与子嗣的内斗让他越来越着急，他必须要尽快击败自己的老友曹操。乱世中最强大的诸候，利用了屡次带来祸患的真传之秘，这将是最可怕的一场决战。

  （玩家未使用过复活） 1号位凡人  2号位魇颜良文丑  3号位魇袁绍  4号位魇沮授

  （玩家已使用过复活） 1号位凡人  2号位魇郭图逄纪  3号位魇审配
  
  **第九关：卧龙出山**

  官渡之战袁绍落败后，仓皇逃往北方。就当各方势力以为天下会太平一段时间时，南方传来消息，驻屯于南阳新野的刘备邀请神鬼莫测的军师诸葛亮出山，并集结大军北伐，一路势如破竹，已逼近许昌。传闻官渡之战后消失不见的真传之秘，又重现在战场上。
  
  1号位凡人  2号位魇关羽  3号位魇张飞  4号位魇赵云  5号位魇刘备

  **第十关：镇南将军**

  刘表在博望坡一战后，再也没有逐鹿中原的决心。外部有曹操在北方虎视眈眈，内部自己的两个儿子正斗着你死我活，自己的身子也是每况愈下。刘表看着手中的真传之秘，眼神中流露出不甘。
  
  1号位凡人  2号位魇刘琦  3号位魇刘表  4号位魇蔡夫人
]]

local ofl_taixu_getLogic = function()
  ---@class LogicOflTaixu: GameLogic
  local ofl_taixu_logic = GameLogic:subclass("ofl_taixu_logic")

  function ofl_taixu_logic:initialize(room)
    GameLogic.initialize(self, room)
    self.role_table = {
      nil,
      nil,
      { "lord", "hidden", "hidden" },
      { "lord", "hidden", "hidden", "hidden" },
      { "lord", "hidden", "hidden", "hidden", "hidden" },
    }
  end

  function ofl_taixu_logic:assignRoles()
    local room = self.room ---@type Room
    local human = table.filter(room.players, function (p)
      return p.serverplayer:getState() == fk.Player_Online
    end)
    if #human > 0 then
      table.shuffle(room.players)
      local roles = self.role_table[#room.players]
      human = table.random(human)
      table.removeOne(room.players, human)
      table.insert(room.players, 1, human)
      for i = 1, #room.players do
        local p = room.players[i]
        p.role = roles[i]
        room:setPlayerProperty(p, "role_shown", true)
        room:broadcastProperty(p, "role")
      end
      room:setCurrent(human)
      room:setBanner("ofl_taixu_warrior", human.id)
      room:setBanner("@ofl_taixu_warrior_hp", 10)
    else
      room:gameOver("")
    end
  end

  function ofl_taixu_logic:chooseGenerals()
    local room = self.room ---@type Room

    local warrior = room:getPlayerById(room:getBanner("ofl_taixu_warrior"))
    local warrior_general = Fk.generals[warrior._splayer:getAvatar()] or Fk.generals["os__gexuan"] or Fk.generals["blank_shibing"]
    room:setPlayerGeneral(warrior, warrior_general.name, true)
    room:broadcastProperty(warrior, "general")
    room:broadcastProperty(warrior, "kingdom")
    room:setPlayerProperty(warrior, "maxHp", 4)
    room:setPlayerProperty(warrior, "hp", 4)
    room:setPlayerProperty(warrior, "shield", 0)

    local story_generals = {
      {
        table.random({
          "huangjinleishi",
          "zhangchu",
          "js__zhangchu",
          "ty__zhangning",
          "os__zhangning",
          "mayuanyi",
          "zhangmancheng",
          "ol__zhangmancheng",
          "ty__zhangmancheng",
          "peiyuanshao",
          "ol__peiyuanshao",
          "guanhai",
          "ol__guanhai",
          "zhangkai",
          "zhangyan",
          "m_shi__zhangyan",
          "ty__zhangyan",
          "zhangjiaozhangbaozhangliang",
          "yanzhengh",
          "bairao",
          "busi",
          "suigu",
          "heman",
          "yudu",
          "tangzhou",
          "bocai",
          "chengyuanzhi",
          "dengmao",
          "gaosheng",
          "fuyun",
          "taosheng",
        }),
        "ofl_tx__zhangbao",
        "ofl_tx__zhangjiao",
        "ofl_tx__zhangliang"
      },
      {
        table.random({
          "ex__caocao",
          "js__caocao",
          "os_sp__caocao",
          "sx__caocao",
          "mini__caocao",
          "vd__caocao",
          "es__caocao",
          "ofl__caocao",
          "ofl2__caocao",
          "ofl3__caocao",
          "ofl4__caocao",
        }),
        "ofl_tx__zhangrang",
        "ofl_tx__hejin",
        "ofl_tx__yuanshao",
      },
      table.random({
        { "ofl_tx__lijue", "ofl_tx__fanchou", "ofl_tx__guosi", "ofl_tx__zhangji" },
        { "ofl_tx2__gaoshun", "ofl_tx__lvbu", "ofl_tx__liru", "ofl_tx__dongzhuo" },
      }),
      {
        "ofl_tx__jiling",
        "ofl_tx__dragon",
        "ofl_tx__yuejiu",
        "ofl_tx__yuanshu",
      },
      {
        "ofl_tx__gaoshun",
        "ofl_tx__godlvbu",
        "ofl_tx__zhangliao",
        "ofl_tx__chengong",
      },
      {
        table.random({ "gongsunfan", "yangang" }),
        "ofl_tx__quyi",
        "ofl_tx__gongsunzan",
        "ofl_tx__zhaoyun",
      },
      table.random({
        {"ofl_tx__zhouyu", "ofl_tx__taishici", "ofl_tx__sunce", "ofl_tx__daqiao"},
        { "ofl_tx__daqiao", "ofl_tx__xiaoqiao", "ofl_tx__zhouyu", "ofl_tx__sunce" },
      }),
      {
        table.random({ "ofl_tx__guotupangji", "ofl_tx__shenpei" }),
        "ofl_tx__yanliangwenchou",
        "ofl_tx__yuanshao",
        "ofl_tx__jvshou",
      },
      {
        "ofl_tx__guanyu",
        "ofl_tx__zhangfei",
        "ofl_tx2__zhaoyun",
        table.random({ "ofl_tx__liubei", "ofl_tx__wolong" }),
      },
      {
        table.random({ "ofl_tx__ganning", "ofl_tx__zhangxiu", "zhangyun" }),
        "ofl_tx__liuqi",
        "ofl_tx__liubiao",
        "ofl_tx__caifuren",
      },
    }

    local stories = {}
    for i = 1, 10 do
      table.insert(stories, "ofl_taixu_story_"..i)
    end
    local story = room:askToChoice(warrior, {
      choices = stories,
      skill_name = "game_rule",
      prompt = "#ofl_taixu_story",
    })
    room:setBanner("@ofl_taixu_story", story)
    story = tonumber(story:sub(17))
    for i = #room.players, 2, -1 do
      local p = room.players[i]
      local g = story_generals[story][4 - #room.players + i]
      if not Fk.generals[g] then
        g = "caocao"
      end
      room:setPlayerGeneral(p, g, true)
      room:broadcastProperty(p, "general")
      room:broadcastProperty(p, "kingdom")
      room:setPlayerProperty(p, "maxHp", Fk.generals[g].maxHp)
      room:setPlayerProperty(p, "hp", Fk.generals[g].hp)
      room:setPlayerProperty(p, "shield", 0)
    end

    local ban_list = {
      "lingju", "ol__dongzhao",
      "ofl__godjiaxu",
      "js__xushao", "js_re__xushao",
      "shichangshi",
      "nd_story__zhangbao", "nd_story__zhangliang",
    }
    for _, g in ipairs(ban_list) do
      table.removeOne(room.general_pile, g)
    end

    local n = 2 + (story // 2)
    local generals = Fk:getGeneralsRandomly(n + 1)
    generals = table.map(generals, Util.NameMapper)
    generals = room:askToChooseGeneral(warrior, {
      generals = generals,
      n = n,
    })
    local gs, skills = {}, {}
    for _, g in ipairs(generals) do
      for _, s in ipairs(Fk.generals[g]:getSkillNameList(false)) do
        table.insert(gs, g)
        table.insert(skills, s)
      end
    end
    local result = room:askToCustomDialog(warrior, {
      skill_name = "game_rule",
      qml_path = "packages/utility/qml/ChooseSkillBox.qml",
      extra_data = {
        skills, 2, math.min(4, n), "#ofl_taixu_orig_skills:::"..math.min(4, n), gs
      },
    })
    if result ~= "" then
      result = result
    else
      result = table.random(skills, 2)
    end
    room:setPlayerMark(warrior, "ofl_taixu_skills", result)
  end

  function ofl_taixu_logic:broadcastGeneral()
  end

  function ofl_taixu_logic:attachSkillToPlayers()
    local room = self.room
    for _, p in ipairs(room.alive_players) do
      local skills = {}
      if room:getBanner("ofl_taixu_warrior") == p.id then
        skills = p:getMark("ofl_taixu_skills")
      else
        skills = Fk.generals[p.general]:getSkillNameList()
      end
      room:handleAddLoseSkills(p, table.concat(skills, "|"), nil, false)
    end
  end

  return ofl_taixu_logic
end

local ofl_taixu_mode = fk.CreateGameMode{
  name = "ofl_taixu_mode",
  minPlayer = 3,
  maxPlayer = 5,
  rule = "#ofl_taixu_rule&",
  logic = ofl_taixu_getLogic,
  surrender_func = function(self, playedTime)
    local surrenderJudge = {
      { text = "time limitation: 2 min", passed = playedTime >= 120 },
      { text = "2v2: left you alive", passed = #table.filter(Fk:currentRoom().players, function(p)
      return Self:isFriend(p) and not (p.dead and p.rest == 0)
    end) < 2 and true }
    }
    return surrenderJudge
  end,
  winner_getter = function(self, victim)
    if not victim.surrendered and victim.rest > 0 then
      return ""
    end
    local room = victim.room
    local alive = table.filter(room.players, function(p) ---@type Player[]
      return not p.surrendered and not (p.dead and p.rest == 0)
    end)
    local winner = alive[1]
    for _, p in ipairs(alive) do
      if not p:isFriend(winner) then
        return ""
      end
    end
    return winner.role
  end,
  friend_enemy_judge = function (self, targetOne, targetTwo)
    if targetOne == targetTwo then
      return true
    elseif Fk:currentRoom():getBanner("ofl_taixu_warrior") == targetOne.id or
      Fk:currentRoom():getBanner("ofl_taixu_warrior") == targetTwo.id then
      return false
    end
    return true
  end,
}
Fk:loadTranslationTable{
  ["ofl_taixu_mode"] = "太虚幻魇（线下）",
  [":ofl_taixu_mode"] = desc,
  ["#ofl_taixu_rule"] = "太虚幻魇规则",
  ["#ofl_taixu_story"] = "选择开始游玩的剧本",
  ["#ofl_taixu_orig_skills"] = "选择%arg个初始技能",

  ["@ofl_taixu_story"] = "",
  ["ofl_taixu_story_1"] = "第一关：黄天之怒",
  ["ofl_taixu_story_2"] = "第二关：何进诛宦",
  ["ofl_taixu_story_3"] = "第三关：董卓乱京",
  ["ofl_taixu_story_4"] = "第四关：仲帝野望",
  ["ofl_taixu_story_5"] = "第五关：鬼神之怒",
  ["ofl_taixu_story_6"] = "第六关：白马之锋",
  ["ofl_taixu_story_7"] = "第七关：霸王征程",
  ["ofl_taixu_story_8"] = "第八关：官渡之战",
  ["ofl_taixu_story_9"] = "第九关：卧龙出山",
  ["ofl_taixu_story_10"] = "第十关：镇南将军",

  ["@ofl_taixu_warrior_hp"] = "凡人剩余命数：",
}

return ofl_taixu_mode
